<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI Design Co-Pilot</title>
  <style>
    /* AI Design Co-Pilot Plugin Styles */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background-color: #ffffff;
      font-size: 12px;
      line-height: 1.4;
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: 100%;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-weight: 500;
      color: #333;
      font-size: 11px;
    }

    input {
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      font-family: inherit;
    }

    input:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
    }

    button {
      padding: 8px 12px;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
    }

    button:hover {
      background-color: #0052a3;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    button.secondary {
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
    }

    button.secondary:hover {
      background-color: #e0e0e0;
    }

    .actions {
      display: flex;
      gap: 8px;
      margin-top: auto;
    }

    .status {
      font-size: 11px;
      color: #666;
      text-align: center;
      margin-top: 8px;
    }

    .status-info {
      color: #666;
    }

    .status-success {
      color: #0f7b0f;
    }

    .status-error {
      color: #d32f2f;
    }

    /* Results display styles */
    .results-section {
      display: none;
      flex: 1;
      flex-direction: column;
      gap: 8px;
      min-height: 200px;
      margin-top: 12px;
      border-top: 1px solid #e0e0e0;
      padding-top: 12px;
    }

    .results-section.visible {
      display: flex;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .results-title {
      font-weight: 600;
      font-size: 12px;
      color: #333;
    }

    .copy-button {
      padding: 4px 8px;
      font-size: 11px;
      background-color: transparent;
      color: #0066cc;
      border: 1px solid #0066cc;
    }

    .copy-button:hover {
      background-color: #0066cc;
      color: white;
    }

    .results-content {
      flex: 1;
      overflow-y: auto;
      background-color: #f5f5f5;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 12px;
      font-size: 11px;
      line-height: 1.5;
      white-space: pre-wrap;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
    }

    .results-content h3 {
      margin: 0 0 8px 0;
      font-size: 12px;
      font-weight: 600;
      color: #333;
    }

    .results-content p {
      margin: 0 0 12px 0;
    }

    .results-content ul {
      margin: 0 0 12px 0;
      padding-left: 20px;
    }

    .results-content li {
      margin: 0 0 4px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- API Key Configuration Section -->
    <div class="input-group">
      <label for="api-key">Claude API Key:</label>
      <input
        type="password"
        id="api-key"
        placeholder="Enter your Claude API key..."
        autocomplete="off"
      >
    </div>

    <!-- Action Buttons -->
    <div class="actions">
      <button id="save-key" class="secondary">Save Key</button>
      <button id="analyze-component" disabled>Analyze Selected Component</button>
    </div>

    <!-- Status Display -->
    <div class="status" id="status">
      Enter API key to get started
    </div>

    <!-- Results Section -->
    <div class="results-section" id="results-section">
      <div class="results-header">
        <span class="results-title">Analysis Results</span>
        <button class="copy-button" id="copy-results">Copy</button>
      </div>
      <div class="results-content" id="results-content">
        <!-- Analysis results will appear here -->
      </div>
    </div>
  </div>

  <!-- Inline JavaScript for better Figma plugin compatibility -->
  <script>
    console.log('UI JavaScript loading...');

    // UI Logic for AI Design Co-Pilot Figma Plugin
    // DOM Elements
    const apiKeyInput = document.getElementById('api-key');
    const saveKeyButton = document.getElementById('save-key');
    const analyzeButton = document.getElementById('analyze-component');
    const statusDiv = document.getElementById('status');
    const resultsSection = document.getElementById('results-section');
    const resultsContent = document.getElementById('results-content');
    const copyButton = document.getElementById('copy-results');

    // State management
    let apiKeySaved = false;

    // Initialize UI event listeners
    function initializeUI() {
      console.log('Initializing UI...');

      // Check if elements exist
      if (!apiKeyInput || !saveKeyButton || !analyzeButton || !statusDiv) {
        console.error('UI elements not found:', {
          apiKeyInput: !!apiKeyInput,
          saveKeyButton: !!saveKeyButton,
          analyzeButton: !!analyzeButton,
          statusDiv: !!statusDiv
        });
        return;
      }

      console.log('UI elements found, setting up event listeners');

      // Save API Key button click handler
      saveKeyButton.addEventListener('click', handleSaveApiKeyUI);

      // Analyze Component button click handler
      analyzeButton.addEventListener('click', handleAnalyzeComponentUI);

      // API Key input change handler - enable/disable analyze button
      apiKeyInput.addEventListener('input', handleApiKeyChange);

            // Listen for messages from the plugin backend
      window.addEventListener('message', handlePluginMessage);

      // Copy button click handler
      copyButton.addEventListener('click', handleCopyResults);

      // Request current API key status from backend
      sendMessageToPlugin('check-api-key', {});
    }

    // Handle API key input changes
    function handleApiKeyChange() {
      const hasApiKey = apiKeyInput.value.trim().length > 0;
      updateAnalyzeButtonState(hasApiKey && apiKeySaved);
    }

    // Handle Save API Key button click
    function handleSaveApiKeyUI() {
      console.log('Save API Key button clicked');
      const apiKey = apiKeyInput.value.trim();
      console.log('API Key value:', apiKey ? `${apiKey.substring(0, 5)}...` : 'empty');

      if (!apiKey) {
        updateStatus('Please enter an API key', 'error');
        return;
      }

      // Disable save button during processing
      saveKeyButton.disabled = true;
      updateStatus('Saving API key...', 'info');

      // Send API key to plugin backend
      sendMessageToPlugin('save-api-key', { apiKey });
    }

    // Handle Analyze Component button click
    function handleAnalyzeComponentUI() {
      if (!apiKeySaved) {
        updateStatus('Please save API key first', 'error');
        return;
      }

      // Disable analyze button during processing
      analyzeButton.disabled = true;
      updateStatus('Analyzing selected component...', 'info');

      // Send analyze request to plugin backend
      sendMessageToPlugin('analyze', {});
    }

    // Handle messages from the plugin backend
    function handlePluginMessage(event) {
      const { type, data } = event.data.pluginMessage || {};

      switch (type) {
        case 'api-key-saved':
          handleApiKeySaved(data.success);
          break;
        case 'api-key-status':
          handleApiKeyStatus(data.hasKey);
          break;
        case 'analysis-complete':
          handleAnalysisComplete(data.success, data.message);
          break;
        case 'analysis-result':
          handleAnalysisResult(data.analysis);
          break;
        case 'analysis-error':
          handleAnalysisError(data.error);
          break;
        default:
          console.log('Unknown message type:', type);
      }
    }

    // Handle API key save response
    function handleApiKeySaved(success) {
      saveKeyButton.disabled = false;

      if (success) {
        apiKeySaved = true;
        updateStatus('API key saved successfully!', 'success');
        updateAnalyzeButtonState(true);

        // Clear the input field for security
        apiKeyInput.value = '';
      } else {
        updateStatus('Failed to save API key', 'error');
      }
    }

    // Handle API key status response
    function handleApiKeyStatus(hasKey) {
      apiKeySaved = hasKey;

      if (hasKey) {
        updateStatus('API key is configured', 'success');
        updateAnalyzeButtonState(true);
      } else {
        updateStatus('Enter API key to get started', 'info');
        updateAnalyzeButtonState(false);
      }
    }

    // Handle analysis completion
    function handleAnalysisComplete(success, message) {
      analyzeButton.disabled = false;

      if (success) {
        updateStatus('Analysis complete! Check Figma notifications.', 'success');
      } else {
        updateStatus(`Analysis failed: ${message}`, 'error');
      }
    }

    // Handle analysis error
    function handleAnalysisError(error) {
      analyzeButton.disabled = false;
      updateStatus(`Error: ${error}`, 'error');
    }

    // Update the analyze button state
    function updateAnalyzeButtonState(enabled) {
      analyzeButton.disabled = !enabled;
    }

    // Update status message with different types
    function updateStatus(message, type = 'info') {
      statusDiv.textContent = message;

      // Remove existing type classes
      statusDiv.classList.remove('status-info', 'status-success', 'status-error');

      // Add new type class
      statusDiv.classList.add(`status-${type}`);
    }

    // Send message to plugin backend
    function sendMessageToPlugin(type, data) {
      console.log('Sending message to plugin:', type, data);
      try {
        parent.postMessage({
          pluginMessage: { type, data }
        }, '*');
      } catch (error) {
        console.error('Failed to send message to plugin:', error);
        // Also try window.parent as fallback
        try {
          window.parent.postMessage({
            pluginMessage: { type, data }
          }, '*');
        } catch (fallbackError) {
          console.error('Fallback also failed:', fallbackError);
        }
      }
    }

    // Handle analysis result display
    function handleAnalysisResult(analysis) {
      console.log('Displaying analysis result:', analysis);

      // Show the results section
      resultsSection.classList.add('visible');

      // Format and display the analysis
      const formattedAnalysis = formatAnalysisForDisplay(analysis);
      resultsContent.innerHTML = formattedAnalysis;

      // Update status
      updateStatus('Analysis complete!', 'success');
    }

    // Format analysis text for HTML display
    function formatAnalysisForDisplay(analysis) {
      // Convert the plain text analysis to HTML with better formatting
      const lines = analysis.split('\n');
      let html = '';
      let inList = false;

      lines.forEach(line => {
        const trimmedLine = line.trim();

        // Headers (lines ending with :)
        if (trimmedLine.endsWith(':') && !trimmedLine.startsWith('•')) {
          if (inList) {
            html += '</ul>';
            inList = false;
          }
          html += `<h3>${trimmedLine}</h3>`;
        }
        // List items
        else if (trimmedLine.startsWith('•')) {
          if (!inList) {
            html += '<ul>';
            inList = true;
          }
          html += `<li>${trimmedLine.substring(1).trim()}</li>`;
        }
        // Regular paragraphs
        else if (trimmedLine) {
          if (inList) {
            html += '</ul>';
            inList = false;
          }
          html += `<p>${trimmedLine}</p>`;
        }
      });

      if (inList) {
        html += '</ul>';
      }

      return html;
    }

    // Handle copy button click
    function handleCopyResults() {
      const textContent = resultsContent.innerText;

      if (!textContent) {
        updateStatus('No results to copy', 'error');
        return;
      }

      // Copy to clipboard
      navigator.clipboard.writeText(textContent).then(() => {
        updateStatus('Copied to clipboard!', 'success');

        // Change button text temporarily
        const originalText = copyButton.textContent;
        copyButton.textContent = 'Copied!';
        setTimeout(() => {
          copyButton.textContent = originalText;
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        updateStatus('Failed to copy to clipboard', 'error');
      });
    }

    // Initialize immediately since script is at bottom of body
    console.log('Initializing UI immediately...');
    initializeUI();
  </script>
</body>
</html>
