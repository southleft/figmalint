<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI Design Co-Pilot</title>
  <style>
    /* Modern UI Design System for AI Design Co-Pilot */
    :root {
      /* Color Palette - Figma-inspired */
      --primary: #18A0FB;
      --primary-hover: #0090F0;
      --primary-light: #E6F4FF;
      --secondary: #5E6470;
      --background: #FFFFFF;
      --surface: #F5F5F5;
      --surface-hover: #EBEBEB;
      --border: #E1E1E1;
      --text-primary: #1C1C1C;
      --text-secondary: #5E6470;
      --text-tertiary: #8B8B8B;
      --success: #06C167;
      --error: #F24822;
      --warning: #FFAA00;
      --info: #18A0FB;

      /* Spacing System */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;

      /* Border Radius */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;

      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-base: 250ms ease;
      --transition-slow: 350ms ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--surface);
      color: var(--text-primary);
      font-size: 13px;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--background);
    }

    /* Header Section */
    .header {
      padding: var(--space-md);
      background: var(--background);
      border-bottom: 1px solid var(--border);
    }

    .plugin-title {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-xs);
    }

    .plugin-icon {
      width: 20px;
      height: 20px;
      background: var(--primary);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 11px;
    }

    .plugin-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .plugin-description {
      font-size: 12px;
      color: var(--text-secondary);
      margin: 0;
    }

    /* Main Content */
    .content {
      flex: 1;
      padding: var(--space-md);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    /* Card Component */
    .card {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-base);
    }

    .card:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--primary-light);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-sm);
    }

    .card-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-secondary);
      margin: var(--space-xs) 0 0 0;
    }

    /* Form Elements */
    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    label {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    input {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      padding-right: 40px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 13px;
      font-family: inherit;
      background: var(--background);
      color: var(--text-primary);
      transition: all var(--transition-fast);
    }

    input:hover {
      border-color: var(--text-tertiary);
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    input::placeholder {
      color: var(--text-tertiary);
    }

    .input-icon {
      position: absolute;
      right: var(--space-sm);
      color: var(--text-tertiary);
      pointer-events: none;
    }

    /* Button Styles */
    .button {
      padding: var(--space-sm) var(--space-md);
      border: none;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      min-height: 32px;
    }

    .button-primary {
      background: var(--primary);
      color: white;
    }

    .button-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .button-primary:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    .button-secondary {
      background: var(--surface);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .button-secondary:hover:not(:disabled) {
      background: var(--surface-hover);
      border-color: var(--text-tertiary);
    }

    .button-ghost {
      background: transparent;
      color: var(--primary);
      border: 1px solid transparent;
    }

    .button-ghost:hover:not(:disabled) {
      background: var(--primary-light);
      border-color: var(--primary-light);
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .button-group {
      display: flex;
      gap: var(--space-sm);
      align-items: center;
    }

    .button-icon {
      width: 16px;
      height: 16px;
    }

    /* Status Messages */
    .status-banner {
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      transition: all var(--transition-base);
      margin-top: var(--space-sm);
    }

    .status-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .status-info {
      background: var(--primary-light);
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .status-success {
      background: #E7F9F0;
      color: var(--success);
      border: 1px solid var(--success);
    }

    .status-error {
      background: #FFEBE7;
      color: var(--error);
      border: 1px solid var(--error);
    }

    .status-warning {
      background: #FFF4E0;
      color: var(--warning);
      border: 1px solid var(--warning);
    }

    /* Results Section */
    .results-container {
      display: none;
      flex: 1;
      flex-direction: column;
      gap: var(--space-md);
      min-height: 0;
    }

    .results-container.visible {
      display: flex;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: var(--space-sm);
      border-bottom: 1px solid var(--border);
    }

    .results-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .results-actions {
      display: flex;
      gap: var(--space-xs);
    }

    /* Results Content Area */
    .results-content {
      flex: 1;
      overflow-y: auto;
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.8;
      color: var(--text-primary);
      position: relative;
    }

    .results-content::-webkit-scrollbar {
      width: 8px;
    }

    .results-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .results-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .results-content::-webkit-scrollbar-thumb:hover {
      background: var(--text-tertiary);
    }

    /* Metadata Display Styles */
    .metadata-section {
      margin-bottom: var(--space-lg);
      padding-bottom: var(--space-lg);
      border-bottom: 1px solid var(--border);
    }

    .metadata-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .metadata-header {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 var(--space-sm) 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, sans-serif;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .metadata-content {
      color: var(--text-secondary);
      margin: 0 0 var(--space-sm) 0;
    }

    .metadata-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-xs);
    }

    .metadata-item {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 2px 8px;
      font-size: 11px;
      color: var(--text-primary);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .metadata-item.prop {
      border-color: var(--primary);
      color: var(--primary);
      background: var(--primary-light);
    }

    .metadata-item.state {
      border-color: var(--success);
      color: var(--success);
      background: #E7F9F0;
    }

    .metadata-item.slot {
      border-color: var(--warning);
      color: var(--warning);
      background: #FFF4E0;
    }

    /* Loading States */
    .skeleton {
      background: linear-gradient(90deg, var(--surface) 25%, var(--surface-hover) 50%, var(--surface) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: var(--radius-sm);
      height: 16px;
      margin: var(--space-xs) 0;
    }

    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Spinner */
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--surface);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Footer Links */
    .footer-links {
      padding: var(--space-sm) var(--space-md);
      text-align: center;
      border-top: 1px solid var(--border);
      background: var(--surface);
    }

    .footer-link {
      font-size: 11px;
      color: var(--text-tertiary);
      text-decoration: none;
      transition: color var(--transition-fast);
    }

    .footer-link:hover {
      color: var(--primary);
      text-decoration: underline;
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }

    .mt-sm { margin-top: var(--space-sm); }
    .mt-md { margin-top: var(--space-md); }
    .mb-sm { margin-bottom: var(--space-sm); }
    .mb-md { margin-bottom: var(--space-md); }

    /* Responsive Design */
    @media (max-height: 600px) {
      .header {
        padding: var(--space-sm) var(--space-md);
      }

      .content {
        padding: var(--space-sm) var(--space-md);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="plugin-title">
        <div class="plugin-icon">AI</div>
        <h1 class="plugin-name">Design Co-Pilot</h1>
      </div>
      <p class="plugin-description">Analyze components with AI-powered insights</p>
    </div>

    <!-- Main Content -->
    <div class="content">
      <!-- API Key Configuration Card -->
      <div class="card" id="api-key-card">
        <div class="card-header">
          <h2 class="card-title">Configuration</h2>
        </div>

        <div class="form-group">
          <label for="api-key">Claude API Key</label>
          <div class="input-wrapper">
            <input
              type="password"
              id="api-key"
              placeholder="sk-ant-..."
              autocomplete="off"
            >
            <span class="input-icon">üîê</span>
          </div>
          <p class="card-subtitle">Your API key is stored securely in this session</p>
        </div>

        <div class="button-group mt-md">
          <button id="save-key" class="button button-secondary">
            <span>Save Key</span>
          </button>
          <button id="analyze-component" class="button button-primary" disabled>
            <span>Analyze Component</span>
          </button>
        </div>

        <!-- Status Message -->
        <div id="status-container" class="hidden">
          <div class="status-banner" id="status">
            <span class="status-icon" id="status-icon"></span>
            <span id="status-text">Ready to analyze</span>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="results-container" id="results-section">
        <div class="card">
          <div class="results-header">
            <h2 class="results-title">
              <span>Analysis Results</span>
              <div class="spinner hidden" id="loading-spinner"></div>
            </h2>
            <div class="results-actions">
              <button class="button button-ghost" id="copy-results">
                <span>Copy</span>
              </button>
              <button class="button button-ghost hidden" id="export-results">
                <span>Export</span>
              </button>
              <button class="button button-primary hidden" id="generate-variants">
                <span>Apply & Generate</span>
              </button>
            </div>
          </div>

          <div class="results-content" id="results-content">
            <div class="skeleton"></div>
            <div class="skeleton" style="width: 80%;"></div>
            <div class="skeleton" style="width: 60%;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer-links">
      <a href="#" id="clear-api-key" class="footer-link hidden">Clear saved API key</a>
    </div>
  </div>

  <!-- Inline JavaScript for better Figma plugin compatibility -->
  <script>
    console.log('UI JavaScript loading...');

    // UI Logic for AI Design Co-Pilot Figma Plugin
    // DOM Elements
    const apiKeyInput = document.getElementById('api-key');
    const saveKeyButton = document.getElementById('save-key');
    const analyzeButton = document.getElementById('analyze-component');
    const statusContainer = document.getElementById('status-container');
    const statusDiv = document.getElementById('status');
    const statusIcon = document.getElementById('status-icon');
    const statusText = document.getElementById('status-text');
    const resultsSection = document.getElementById('results-section');
    const resultsContent = document.getElementById('results-content');
    const copyButton = document.getElementById('copy-results');
    const exportButton = document.getElementById('export-results');
    const generateVariantsButton = document.getElementById('generate-variants');
    const clearApiKeyLink = document.getElementById('clear-api-key');
    const loadingSpinner = document.getElementById('loading-spinner');

    // State management
    let apiKeySaved = false;
    let currentMetadata = null;

    // Status icons
    const statusIcons = {
      info: '‚ÑπÔ∏è',
      success: '‚úÖ',
      error: '‚ùå',
      warning: '‚ö†Ô∏è'
    };

    // Initialize UI event listeners
    function initializeUI() {
      console.log('Initializing UI...');

      // Check if elements exist
      if (!apiKeyInput || !saveKeyButton || !analyzeButton || !statusDiv) {
        console.error('UI elements not found:', {
          apiKeyInput: !!apiKeyInput,
          saveKeyButton: !!saveKeyButton,
          analyzeButton: !!analyzeButton,
          statusDiv: !!statusDiv
        });
        return;
      }

      console.log('UI elements found, setting up event listeners');

      // Save API Key button click handler
      saveKeyButton.addEventListener('click', handleSaveApiKeyUI);

      // Analyze Component button click handler
      analyzeButton.addEventListener('click', handleAnalyzeComponentUI);

      // API Key input change handler - enable/disable analyze button
      apiKeyInput.addEventListener('input', handleApiKeyChange);

      // Enter key support for API key input
      apiKeyInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && apiKeyInput.value.trim()) {
          handleSaveApiKeyUI();
        }
      });

      // Listen for messages from the plugin backend
      window.addEventListener('message', handlePluginMessage);

      // Copy button click handler
      copyButton.addEventListener('click', handleCopyResults);

      // Export button click handler
      exportButton.addEventListener('click', handleExportResults);

      // Generate variants button click handler
      generateVariantsButton.addEventListener('click', handleGenerateVariants);

      // Clear API key link click handler
      clearApiKeyLink.addEventListener('click', handleClearApiKey);

      // Request current API key status from backend
      sendMessageToPlugin('check-api-key', {});
    }

    // Handle API key input changes
    function handleApiKeyChange() {
      const hasApiKey = apiKeyInput.value.trim().length > 0;
      if (hasApiKey && apiKeySaved) {
        updateAnalyzeButtonState(true);
      }
    }

    // Handle Save API Key button click
    function handleSaveApiKeyUI() {
      console.log('Save API Key button clicked');
      const apiKey = apiKeyInput.value.trim();
      console.log('API Key value:', apiKey ? `${apiKey.substring(0, 5)}...` : 'empty');

      if (!apiKey) {
        updateStatus('Please enter an API key', 'error');
        return;
      }

      // Disable save button during processing
      saveKeyButton.disabled = true;
      updateStatus('Saving API key...', 'info');

      // Send API key to plugin backend
      sendMessageToPlugin('save-api-key', { apiKey });
    }

    // Handle Analyze Component button click
    function handleAnalyzeComponentUI() {
      if (!apiKeySaved) {
        updateStatus('Please save API key first', 'error');
        return;
      }

      // Show loading state
      analyzeButton.disabled = true;
      loadingSpinner.classList.remove('hidden');
      updateStatus('Analyzing selected component...', 'info');

      // Show results section with skeletons
      resultsSection.classList.add('visible');
      resultsContent.innerHTML = `
        <div class="skeleton"></div>
        <div class="skeleton" style="width: 80%;"></div>
        <div class="skeleton" style="width: 60%;"></div>
      `;

      // Send enhanced analyze request to plugin backend
      sendMessageToPlugin('analyze-enhanced', {});
    }

    // Handle messages from the plugin backend
    function handlePluginMessage(event) {
      const { type, data } = event.data.pluginMessage || {};

      switch (type) {
        case 'api-key-saved':
          handleApiKeySaved(data.success);
          break;
        case 'api-key-status':
          handleApiKeyStatus(data.hasKey);
          break;
        case 'analysis-complete':
          handleAnalysisComplete(data.success, data.message);
          break;
        case 'analysis-result':
          handleAnalysisResult(data.analysis);
          break;
        case 'metadata-result':
          handleMetadataResult(data.metadata);
          break;
        case 'enhanced-analysis-result':
          handleEnhancedAnalysisResult(data);
          break;
        case 'analysis-error':
          handleAnalysisError(data.error);
          break;
        case 'variants-generated':
          handleVariantsGenerated(data);
          break;
        case 'metadata-embedded':
          handleMetadataEmbedded(data);
          break;
        default:
          console.log('Unknown message type:', type);
      }
    }

    // Handle API key save response
    function handleApiKeySaved(success) {
      saveKeyButton.disabled = false;

      if (success) {
        apiKeySaved = true;
        updateStatus('API key saved successfully!', 'success');
        updateAnalyzeButtonState(true);
        clearApiKeyLink.classList.remove('hidden');

        // Clear the input field for security
        apiKeyInput.value = '';
        apiKeyInput.placeholder = 'API key saved ‚úì';
      } else {
        updateStatus('Failed to save API key', 'error');
      }
    }

    // Handle API key status response
    function handleApiKeyStatus(hasKey) {
      apiKeySaved = hasKey;

      if (hasKey) {
        updateStatus('API key is configured', 'success');
        updateAnalyzeButtonState(true);
        clearApiKeyLink.classList.remove('hidden');
        apiKeyInput.placeholder = 'API key saved ‚úì';
      } else {
        updateStatus('Enter API key to get started', 'info');
        updateAnalyzeButtonState(false);
        clearApiKeyLink.classList.add('hidden');
      }
    }

    // Handle clear API key
    function handleClearApiKey(e) {
      e.preventDefault();

      if (confirm('Are you sure you want to clear the saved API key?')) {
        sendMessageToPlugin('clear-api-key', {});
        apiKeyInput.value = '';
        apiKeyInput.placeholder = 'sk-ant-...';
        clearApiKeyLink.classList.add('hidden');
        apiKeySaved = false;
        updateAnalyzeButtonState(false);
        updateStatus('API key cleared', 'info');
      }
    }

    // Handle analysis completion
    function handleAnalysisComplete(success, message) {
      analyzeButton.disabled = false;
      loadingSpinner.classList.add('hidden');

      if (success) {
        updateStatus('Analysis complete!', 'success');
      } else {
        updateStatus(`Analysis failed: ${message}`, 'error');
      }
    }

    // Handle analysis error
    function handleAnalysisError(error) {
      analyzeButton.disabled = false;
      loadingSpinner.classList.add('hidden');
      updateStatus(`Error: ${error}`, 'error');

      // Clear loading skeletons
      resultsContent.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
          <p style="font-size: 16px; margin-bottom: 8px;">‚ùå</p>
          <p>Analysis failed. Please try again.</p>
        </div>
      `;
    }

    // Update the analyze button state
    function updateAnalyzeButtonState(enabled) {
      analyzeButton.disabled = !enabled;
    }

    // Update status message with different types
    function updateStatus(message, type = 'info') {
      statusContainer.classList.remove('hidden');
      statusText.textContent = message;
      statusIcon.textContent = statusIcons[type] || statusIcons.info;

      // Remove existing type classes
      statusDiv.classList.remove('status-info', 'status-success', 'status-error', 'status-warning');

      // Add new type class
      statusDiv.classList.add(`status-${type}`);

      // Auto-hide success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          statusContainer.classList.add('hidden');
        }, 5000);
      }
    }

    // Send message to plugin backend
    function sendMessageToPlugin(type, data) {
      console.log('Sending message to plugin:', type, data);
      try {
        parent.postMessage({
          pluginMessage: { type, data }
        }, '*');
      } catch (error) {
        console.error('Failed to send message to plugin:', error);
        // Also try window.parent as fallback
        try {
          window.parent.postMessage({
            pluginMessage: { type, data }
          }, '*');
        } catch (fallbackError) {
          console.error('Fallback also failed:', fallbackError);
        }
      }
    }

    // Handle analysis result display
    function handleAnalysisResult(analysis) {
      console.log('Displaying analysis result:', analysis);

      // Show the results section
      resultsSection.classList.add('visible');
      loadingSpinner.classList.add('hidden');

      // Format and display the analysis
      const formattedAnalysis = formatAnalysisForDisplay(analysis);
      resultsContent.innerHTML = formattedAnalysis;

      // Update status
      updateStatus('Analysis complete!', 'success');
    }

    // Format analysis text for HTML display
    function formatAnalysisForDisplay(analysis) {
      // Convert the plain text analysis to HTML with better formatting
      const lines = analysis.split('\n');
      let html = '';
      let inList = false;

      lines.forEach(line => {
        const trimmedLine = line.trim();

        // Headers (lines ending with :)
        if (trimmedLine.endsWith(':') && !trimmedLine.startsWith('‚Ä¢')) {
          if (inList) {
            html += '</ul>';
            inList = false;
          }
          html += `<h3 class="metadata-header">${trimmedLine}</h3>`;
        }
        // List items
        else if (trimmedLine.startsWith('‚Ä¢')) {
          if (!inList) {
            html += '<ul class="metadata-list">';
            inList = true;
          }
          html += `<li class="metadata-item">${trimmedLine.substring(1).trim()}</li>`;
        }
        // Regular paragraphs
        else if (trimmedLine) {
          if (inList) {
            html += '</ul>';
            inList = false;
          }
          html += `<p class="metadata-content">${trimmedLine}</p>`;
        }
      });

      if (inList) {
        html += '</ul>';
      }

      return html;
    }

    // Handle copy button click
    function handleCopyResults() {
      // Check if we have metadata to copy
      const copyContent = currentMetadata ? JSON.stringify(currentMetadata, null, 2) : resultsContent.innerText;

      if (!copyContent) {
        updateStatus('No results to copy', 'error');
        return;
      }

      // Copy to clipboard
      navigator.clipboard.writeText(copyContent).then(() => {
        updateStatus(currentMetadata ? 'Copied metadata JSON!' : 'Copied to clipboard!', 'success');

        // Change button text temporarily
        const originalText = copyButton.querySelector('span').textContent;
        copyButton.querySelector('span').textContent = 'Copied!';
        setTimeout(() => {
          copyButton.querySelector('span').textContent = originalText;
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        updateStatus('Failed to copy to clipboard', 'error');
      });
    }

    // Handle metadata result display
    function handleMetadataResult(metadata) {
      console.log('Displaying metadata result:', metadata);

      // Store current metadata for copying
      currentMetadata = metadata;

      // Show the results section
      resultsSection.classList.add('visible');
      loadingSpinner.classList.add('hidden');

      // Format metadata for display
      let html = '';

      // Component name and description
      html += `<div class="metadata-section">`;
      html += `<h3 class="metadata-header">${metadata.component}</h3>`;
      html += `<p class="metadata-content">${metadata.description}</p>`;
      html += `</div>`;

      // Properties
      if (metadata.props && metadata.props.length > 0) {
        html += '<div class="metadata-section">';
        html += '<h3 class="metadata-header">Properties</h3>';
        html += '<ul class="metadata-list">';
        metadata.props.forEach(prop => {
          html += `<li class="metadata-item prop">${prop}</li>`;
        });
        html += '</ul>';
        html += '</div>';
      }

      // States
      if (metadata.states && metadata.states.length > 0) {
        html += '<div class="metadata-section">';
        html += '<h3 class="metadata-header">States</h3>';
        html += '<ul class="metadata-list">';
        metadata.states.forEach(state => {
          html += `<li class="metadata-item state">${state}</li>`;
        });
        html += '</ul>';
        html += '</div>';
      }

      // Slots
      if (metadata.slots && metadata.slots.length > 0) {
        html += '<div class="metadata-section">';
        html += '<h3 class="metadata-header">Slots</h3>';
        html += '<ul class="metadata-list">';
        metadata.slots.forEach(slot => {
          html += `<li class="metadata-item slot">${slot}</li>`;
        });
        html += '</ul>';
        html += '</div>';
      }

      // Variants
      if (metadata.variants && Object.keys(metadata.variants).length > 0) {
        html += '<div class="metadata-section">';
        html += '<h3 class="metadata-header">Variants</h3>';
        for (const [key, values] of Object.entries(metadata.variants)) {
          html += `<p class="metadata-content"><strong>${key}:</strong></p>`;
          html += '<ul class="metadata-list">';
          if (Array.isArray(values)) {
            values.forEach(value => {
              html += `<li class="metadata-item">${value}</li>`;
            });
          } else {
            html += `<li class="metadata-item">${values}</li>`;
          }
          html += '</ul>';
        }
        html += '</div>';
      }

      // Usage
      if (metadata.usage) {
        html += '<div class="metadata-section">';
        html += '<h3 class="metadata-header">Usage Guidelines</h3>';
        html += `<p class="metadata-content">${metadata.usage}</p>`;
        html += '</div>';
      }

      // Accessibility
      if (metadata.accessibility) {
        html += '<div class="metadata-section">';
        html += '<h3 class="metadata-header">Accessibility</h3>';
        html += `<p class="metadata-content">${metadata.accessibility}</p>`;
        html += '</div>';
      }

      // Tokens
      if (metadata.tokens && Object.keys(metadata.tokens).length > 0) {
        html += '<div class="metadata-section">';
        html += '<h3 class="metadata-header">Design Tokens</h3>';
        for (const [tokenType, tokens] of Object.entries(metadata.tokens)) {
          if (Array.isArray(tokens) && tokens.length > 0) {
            html += `<p class="metadata-content"><strong>${tokenType}:</strong></p>`;
            html += '<ul class="metadata-list">';
            tokens.forEach(token => {
              html += `<li class="metadata-item">${token}</li>`;
            });
            html += '</ul>';
          }
        }
        html += '</div>';
      }

      resultsContent.innerHTML = html;

      // Update status
      updateStatus('Analysis complete!', 'success');

      // Show the generate button if we have states or variants to generate
      if ((metadata.states && metadata.states.length > 0) ||
          (metadata.variants && Object.keys(metadata.variants).length > 0) ||
          (metadata.props && metadata.props.length > 0)) {
        generateVariantsButton.classList.remove('hidden');
      } else {
        generateVariantsButton.classList.add('hidden');
      }
    }

    // Handle export button click
    function handleExportResults() {
      if (!currentMetadata) {
        updateStatus('No results to export', 'error');
        return;
      }

      // Create a blob with the metadata
      const jsonStr = JSON.stringify(currentMetadata, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });

      // Create download link
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentMetadata.component || 'component'}-metadata.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      updateStatus('Metadata exported!', 'success');
    }

    // Handle variants generated
    function handleVariantsGenerated(data) {
      generateVariantsButton.disabled = false;
      loadingSpinner.classList.add('hidden');

      if (data.success) {
        if (data.message) {
          updateStatus(data.message, 'success');
        } else {
          updateStatus(`Generated ${data.count} variant${data.count > 1 ? 's' : ''}!`, 'success');
        }
      } else {
        updateStatus(`Failed to generate variants: ${data.error || 'Unknown error'}`, 'error');
      }
    }

    // Handle metadata embedded
    function handleMetadataEmbedded(data) {
      if (data.success) {
        updateStatus('Metadata embedded in component!', 'success');
      } else {
        updateStatus('Failed to embed metadata', 'error');
      }
    }

    // Handle enhanced analysis result display with expandable descriptions
    function handleEnhancedAnalysisResult(data) {
      console.log('Displaying enhanced analysis result:', data);
      console.log('Token data structure:', data.tokens);

      // Debug: Log token counts for each type
      if (data.tokens) {
        Object.keys(data.tokens).forEach(tokenType => {
          const tokens = data.tokens[tokenType] || [];
          const tokenCount = tokens.filter(t => t.isToken).length;
          const hardCodedCount = tokens.filter(t => !t.isToken).length;
          console.log(`${tokenType}: ${tokenCount} tokens, ${hardCodedCount} hard-coded, ${tokens.length} total`);
        });
      }

      // Store current metadata for copying
      currentMetadata = data.metadata;

      // Show the results section
      resultsSection.classList.add('visible');
      loadingSpinner.classList.add('hidden');

      // Build comprehensive enhanced analysis display
      let html = `
        <!-- Token Analysis Summary -->
        <div class="metadata-section" style="background: #f8f9ff; border: 1px solid #e1e5ff; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <span style="font-size: 16px;">üìä</span>
            <h3 class="metadata-header" style="margin: 0; color: #4a5568;">Token Analysis Summary</h3>
          </div>
          <div style="display: flex; gap: 16px; flex-wrap: wrap;">
      `;

      // Count tokens vs hard-coded values across all token types
      let tokenCount = 0;
      let hardCodedCount = 0;

      // Count across all token types
      Object.keys(data.tokens || {}).forEach(tokenType => {
        const tokens = data.tokens[tokenType] || [];
        tokenCount += tokens.filter(t => t.isToken).length;
        hardCodedCount += tokens.filter(t => !t.isToken).length;
      });

      html += `
            <div style="display: flex; align-items: center; gap: 6px;">
              <span style="color: #10b981;">‚úÖ</span>
              <span style="font-weight: 600; color: #059669;">${tokenCount}</span>
              <span style="color: #6b7280; font-size: 12px;">using design tokens</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <span style="color: #f59e0b;">‚ö†Ô∏è</span>
              <span style="font-weight: 600; color: #d97706;">${hardCodedCount}</span>
              <span style="color: #6b7280; font-size: 12px;">hard-coded values</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <span style="color: #6b7280;">üìä</span>
              <span style="font-weight: 600; color: #4b5563;">${tokenCount + hardCodedCount}</span>
              <span style="color: #6b7280; font-size: 12px;">total properties analyzed</span>
            </div>
          </div>
        </div>
      `;

      // Component details with expandable description
      html += `
        <div class="metadata-section">
          <h3 class="metadata-header" style="display: flex; align-items: center; gap: 8px;">
            <span>üß©</span>
            ${data.metadata.component}
          </h3>
          <div class="expandable-description">
            <div class="description-content" onclick="toggleDescription(this)">
              <p class="metadata-content" style="margin: 0; cursor: pointer; line-height: 1.5;">
                ${data.metadata.description}
                <span class="expand-indicator" style="color: #3b82f6; font-size: 12px; margin-left: 8px;">(click to expand)</span>
              </p>
            </div>
          </div>
        </div>
      `;

      // Tokens section with detailed breakdown
      if (data.tokens && (data.tokens.colors?.length > 0 || data.tokens.spacing?.length > 0 || data.tokens.typography?.length > 0)) {
        html += `
          <div class="metadata-section">
            <h3 class="metadata-header" style="display: flex; align-items: center; gap: 8px;">
              <span>üé®</span>
              Color Tokens
            </h3>
        `;

        // Token colors
        if (data.tokens.colors?.some(c => c.isToken)) {
          html += '<div style="margin-bottom: 16px;"><h4 style="color: #10b981; font-size: 13px; margin: 0 0 8px 0;">‚úÖ Design Tokens</h4>';
          data.tokens.colors.filter(c => c.isToken).forEach(token => {
            html += `
              <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px; margin-bottom: 4px;">
                <div style="width: 16px; height: 16px; border-radius: 3px; background: ${token.value?.startsWith('#') ? token.value : '#ccc'}; border: 1px solid #e5e7eb;"></div>
                <span style="font-family: monospace; font-size: 12px; color: #059669;">${token.name}</span>
                <span style="font-size: 11px; color: #6b7280;">${token.type}</span>
              </div>
            `;
          });
          html += '</div>';
        }

        // Hard-coded colors
        if (data.tokens.colors?.some(c => !c.isToken)) {
          html += '<div><h4 style="color: #d97706; font-size: 13px; margin: 0 0 8px 0;">‚ö†Ô∏è Hard-coded Colors</h4>';
          data.tokens.colors.filter(c => !c.isToken).forEach(token => {
            html += `
              <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #fffbeb; border: 1px solid #fed7aa; border-radius: 4px; margin-bottom: 4px;">
                <div style="width: 16px; height: 16px; border-radius: 3px; background: ${token.value}; border: 1px solid #e5e7eb;"></div>
                <span style="font-family: monospace; font-size: 12px; color: #d97706;">${token.value}</span>
                <span style="font-size: 11px; color: #6b7280;">Replace hard-coded color with semantic token for better maintainability</span>
              </div>
            `;
          });
          html += '</div>';
        }

        html += '</div>';

        // Spacing tokens
        if (data.tokens.spacing?.length > 0) {
          html += `
            <div class="metadata-section">
              <h3 class="metadata-header" style="display: flex; align-items: center; gap: 8px;">
                <span>üìè</span>
                Spacing Tokens
              </h3>
          `;

          if (data.tokens.spacing?.some(s => s.isToken)) {
            html += '<div style="margin-bottom: 16px;"><h4 style="color: #10b981; font-size: 13px; margin: 0 0 8px 0;">‚úÖ Design Tokens</h4>';
            data.tokens.spacing.filter(s => s.isToken).forEach(token => {
              html += `
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px; margin-bottom: 4px;">
                  <span style="width: 16px; height: 16px; background: #10b981; border-radius: 2px;"></span>
                  <span style="font-family: monospace; font-size: 12px; color: #059669;">${token.name}</span>
                  <span style="font-size: 11px; color: #6b7280;">${token.type}</span>
                </div>
              `;
            });
            html += '</div>';
          }

          if (data.tokens.spacing?.some(s => !s.isToken)) {
            html += '<div><h4 style="color: #d97706; font-size: 13px; margin: 0 0 8px 0;">‚ö†Ô∏è Hard-coded Spacing</h4>';
            data.tokens.spacing.filter(s => !s.isToken).forEach(token => {
              html += `
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #fffbeb; border: 1px solid #fed7aa; border-radius: 4px; margin-bottom: 4px;">
                  <span style="width: 16px; height: 16px; background: #d97706; border-radius: 2px;"></span>
                  <span style="font-family: monospace; font-size: 12px; color: #d97706;">${token.value}</span>
                  <span style="font-size: 11px; color: #6b7280;">Consider implementing this spacing token in your design system</span>
                </div>
              `;
            });
            html += '</div>';
          }

          html += '</div>';
        }

        // Typography tokens
        if (data.tokens.typography?.length > 0) {
          html += `
            <div class="metadata-section">
              <h3 class="metadata-header" style="display: flex; align-items: center; gap: 8px;">
                <span>üìù</span>
                Typography Tokens
              </h3>
          `;

          if (data.tokens.typography?.some(t => t.isToken)) {
            html += '<div style="margin-bottom: 16px;"><h4 style="color: #10b981; font-size: 13px; margin: 0 0 8px 0;">‚úÖ Design Tokens</h4>';
            data.tokens.typography.filter(t => t.isToken).forEach(token => {
              html += `
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px; margin-bottom: 4px;">
                  <span style="font-size: 14px;">Aa</span>
                  <span style="font-family: monospace; font-size: 12px; color: #059669;">${token.name}</span>
                  <span style="font-size: 11px; color: #6b7280;">${token.type}</span>
                </div>
              `;
            });
            html += '</div>';
          }

          if (data.tokens.typography?.some(t => !t.isToken)) {
            html += '<div><h4 style="color: #d97706; font-size: 13px; margin: 0 0 8px 0;">‚ö†Ô∏è Hard-coded Typography</h4>';
            data.tokens.typography.filter(t => !t.isToken).forEach(token => {
              html += `
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #fffbeb; border: 1px solid #fed7aa; border-radius: 4px; margin-bottom: 4px;">
                  <span style="font-size: 14px;">Aa</span>
                  <span style="font-family: monospace; font-size: 12px; color: #d97706;">${token.size || token.value}</span>
                  <span style="font-size: 11px; color: #6b7280;">Consider implementing this typography token in your design system</span>
                </div>
              `;
            });
            html += '</div>';
          }

          html += '</div>';
        }

        // Effects tokens
        if (data.tokens.effects?.length > 0) {
          html += `
            <div class="metadata-section">
              <h3 class="metadata-header" style="display: flex; align-items: center; gap: 8px;">
                <span>‚ú®</span>
                Effects Tokens
              </h3>
          `;

          if (data.tokens.effects?.some(e => e.isToken)) {
            html += '<div style="margin-bottom: 16px;"><h4 style="color: #10b981; font-size: 13px; margin: 0 0 8px 0;">‚úÖ Design Tokens</h4>';
            data.tokens.effects.filter(e => e.isToken).forEach(token => {
              html += `
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px; margin-bottom: 4px;">
                  <span style="font-size: 14px;">‚ú®</span>
                  <span style="font-family: monospace; font-size: 12px; color: #059669;">${token.name}</span>
                  <span style="font-size: 11px; color: #6b7280;">${token.type}</span>
                </div>
              `;
            });
            html += '</div>';
          }

          if (data.tokens.effects?.some(e => !e.isToken)) {
            html += '<div><h4 style="color: #d97706; font-size: 13px; margin: 0 0 8px 0;">‚ö†Ô∏è Hard-coded Effects</h4>';
            data.tokens.effects.filter(e => !e.isToken).forEach(token => {
              html += `
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #fffbeb; border: 1px solid #fed7aa; border-radius: 4px; margin-bottom: 4px;">
                  <span style="font-size: 14px;">‚ú®</span>
                  <span style="font-family: monospace; font-size: 12px; color: #d97706;">${token.value}</span>
                  <span style="font-size: 11px; color: #6b7280;">Consider implementing this effect token in your design system</span>
                </div>
              `;
            });
            html += '</div>';
          }

          html += '</div>';
        }

        // Borders tokens
        if (data.tokens.borders?.length > 0) {
          html += `
            <div class="metadata-section">
              <h3 class="metadata-header" style="display: flex; align-items: center; gap: 8px;">
                <span>‚¨ú</span>
                Border Tokens
              </h3>
          `;

          if (data.tokens.borders?.some(b => b.isToken)) {
            html += '<div style="margin-bottom: 16px;"><h4 style="color: #10b981; font-size: 13px; margin: 0 0 8px 0;">‚úÖ Design Tokens</h4>';
            data.tokens.borders.filter(b => b.isToken).forEach(token => {
              html += `
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px; margin-bottom: 4px;">
                  <span style="font-size: 14px;">‚¨ú</span>
                  <span style="font-family: monospace; font-size: 12px; color: #059669;">${token.name}</span>
                  <span style="font-size: 11px; color: #6b7280;">${token.type}</span>
                </div>
              `;
            });
            html += '</div>';
          }

          if (data.tokens.borders?.some(b => !b.isToken)) {
            html += '<div><h4 style="color: #d97706; font-size: 13px; margin: 0 0 8px 0;">‚ö†Ô∏è Hard-coded Borders</h4>';
            data.tokens.borders.filter(b => !b.isToken).forEach(token => {
              html += `
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #fffbeb; border: 1px solid #fed7aa; border-radius: 4px; margin-bottom: 4px;">
                  <span style="font-size: 14px;">‚¨ú</span>
                  <span style="font-family: monospace; font-size: 12px; color: #d97706;">${token.value}</span>
                  <span style="font-size: 11px; color: #6b7280;">Consider implementing this border token in your design system</span>
                </div>
              `;
            });
            html += '</div>';
          }

          html += '</div>';
        }

        // Layout tokens
        if (data.tokens.layout?.length > 0) {
          html += `
            <div class="metadata-section">
              <h3 class="metadata-header" style="display: flex; align-items: center; gap: 8px;">
                <span>üìê</span>
                Layout Tokens
              </h3>
          `;

          if (data.tokens.layout?.some(l => l.isToken)) {
            html += '<div style="margin-bottom: 16px;"><h4 style="color: #10b981; font-size: 13px; margin: 0 0 8px 0;">‚úÖ Design Tokens</h4>';
            data.tokens.layout.filter(l => l.isToken).forEach(token => {
              html += `
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px; margin-bottom: 4px;">
                  <span style="font-size: 14px;">üìê</span>
                  <span style="font-family: monospace; font-size: 12px; color: #059669;">${token.name}</span>
                  <span style="font-size: 11px; color: #6b7280;">${token.type}</span>
                </div>
              `;
            });
            html += '</div>';
          }

          if (data.tokens.layout?.some(l => !l.isToken)) {
            html += '<div><h4 style="color: #d97706; font-size: 13px; margin: 0 0 8px 0;">‚ö†Ô∏è Hard-coded Layout</h4>';
            data.tokens.layout.filter(l => !l.isToken).forEach(token => {
              html += `
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #fffbeb; border: 1px solid #fed7aa; border-radius: 4px; margin-bottom: 4px;">
                  <span style="font-size: 14px;">üìê</span>
                  <span style="font-family: monospace; font-size: 12px; color: #d97706;">${token.value}</span>
                  <span style="font-size: 11px; color: #6b7280;">Consider implementing this layout token in your design system</span>
                </div>
              `;
            });
            html += '</div>';
          }

          html += '</div>';
        }
      }

      // Add other sections as needed (properties, states, etc.)
      // ... (add other sections here)

      resultsContent.innerHTML = html;

      // Update status
      updateStatus('Enhanced analysis complete!', 'success');

      // Show the generate button
      if ((data.metadata.states && data.metadata.states.length > 0) ||
          (data.metadata.variants && Object.keys(data.metadata.variants).length > 0) ||
          (data.metadata.props && data.metadata.props.length > 0)) {
        generateVariantsButton.classList.remove('hidden');
      } else {
        generateVariantsButton.classList.add('hidden');
      }
    }

    // Function to toggle description expansion
    function toggleDescription(element) {
      const content = element.querySelector('.metadata-content');
      const indicator = element.querySelector('.expand-indicator');

      if (content.style.webkitLineClamp) {
        // Currently truncated, expand it
        content.style.webkitLineClamp = 'none';
        content.style.display = 'block';
        indicator.textContent = '(click to collapse)';
      } else {
        // Currently expanded, truncate it
        content.style.display = '-webkit-box';
        content.style.webkitBoxOrient = 'vertical';
        content.style.webkitLineClamp = '3';
        content.style.overflow = 'hidden';
        indicator.textContent = '(click to expand)';
      }
    }

    // Handle generate variants button click
    function handleGenerateVariants() {
      if (!currentMetadata) {
        updateStatus('No results to generate variants', 'error');
        return;
      }

      // Show loading state
      generateVariantsButton.disabled = true;
      loadingSpinner.classList.remove('hidden');
      updateStatus('Generating variants...', 'info');

      // Send generate variants request to plugin backend
      sendMessageToPlugin('generate-variants', { metadata: currentMetadata });
    }

    // Initialize the UI when DOM is loaded
    // Handle both cases: DOM still loading or already loaded (common in Figma plugins)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeUI);
    } else {
      initializeUI();
    }
  </script>
</body>
</html>
